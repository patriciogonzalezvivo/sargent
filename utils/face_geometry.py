# Many parts taken from the cpp implementation from github.com/google/mediapipe 
#
# Copyright 2020 The MediaPipe Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import numpy as np

class Singleton(type):
    _instances = {}
    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super(Singleton, cls).__call__(*args, **kwargs)
        return cls._instances[cls]
    
class Debugger(metaclass=Singleton):
    def set_debug(self, debug):
        self.debug = debug

    def toggle(self):
        self.debug = not self.debug

    def get_debug(self):
        return self.debug

DEBUG = Debugger()
DEBUG.set_debug(False)

class PCF:
    def __init__(self,
                 near=1,
                 far=10000,
                 frame_height=1920,
                 frame_width=1080,
                 fy = 1074.520446598223):

        self.near = near
        self.far = far
        self.frame_height = frame_height
        self.frame_width = frame_width
        self.fy = fy

        fov_y = 2 * np.arctan(frame_height / (2 * fy))
        kDegreesToRadians = np.pi / 180.0
        height_at_near = 2 * near * np.tan(0.5 * fov_y)
        width_at_near = frame_width * height_at_near / frame_height
        
        self.fov_y = fov_y
        self.left = -0.5 * width_at_near;
        self.right = 0.5 * width_at_near;
        self.bottom = -0.5 * height_at_near;
        self.top = 0.5 * height_at_near;

canonical_metric_landmarks = np.array([0.000000,-3.406404,5.979507,0.499977,0.652534,0.000000,-1.126865,7.475604,0.500026,0.547487,0.000000,-2.089024,6.058267,0.499974,0.602372,-0.463928,0.955357,6.633583,0.482113,0.471979,0.000000,-0.463170,7.586580,0.500151,0.527156,0.000000,0.365669,7.242870,0.499910,0.498253,0.000000,2.473255,5.788627,0.499523,0.401062,-4.253081,2.577646,3.279702,0.289712,0.380764,0.000000,4.019042,5.284764,0.499955,0.312398,0.000000,4.885979,5.385258,0.499987,0.269919,0.000000,8.261778,4.481535,0.500023,0.107050,0.000000,-3.706811,5.864924,0.500023,0.666234,0.000000,-3.918301,5.569430,0.500016,0.679224,0.000000,-3.994436,5.219482,0.500023,0.692348,0.000000,-4.542400,5.404754,0.499977,0.695278,0.000000,-4.745577,5.529457,0.499977,0.705934,0.000000,-5.019567,5.601448,0.499977,0.719385,0.000000,-5.365123,5.535441,0.499977,0.737019,0.000000,-6.149624,5.071372,0.499968,0.781371,0.000000,-1.501095,7.112196,0.499816,0.562981,-0.416106,-1.466449,6.447657,0.473773,0.573910,-7.087960,5.434801,0.099620,0.104907,0.254141,-2.628639,2.035898,3.848121,0.365930,0.409576,-3.198363,1.985815,3.796952,0.338758,0.413025,-3.775151,2.039402,3.646194,0.311120,0.409460,-4.465819,2.422950,3.155168,0.274658,0.389131,-2.164289,2.189867,3.851822,0.393362,0.403706,-3.208229,3.223926,4.115822,0.345234,0.344011,-2.673803,3.205337,4.092203,0.370094,0.346076,-3.745193,3.165286,3.972409,0.319322,0.347265,-4.161018,3.059069,3.719554,0.297903,0.353591,-5.062006,1.934418,2.776093,0.247792,0.410810,-2.266659,-7.425768,4.389812,0.396889,0.842755,-4.445859,2.663991,3.173422,0.280098,0.375600,-7.214530,2.263009,0.073150,0.106310,0.399956,-5.799793,2.349546,2.204059,0.209925,0.391353,-2.844939,-0.720868,4.433130,0.355808,0.534406,-0.711452,-3.329355,5.877044,0.471751,0.650404,-0.606033,-3.924562,5.444923,0.474155,0.680192,-1.431615,-3.500953,5.496189,0.439785,0.657229,-1.914910,-3.803146,5.028930,0.414617,0.666541,-1.131043,-3.973937,5.189648,0.450374,0.680861,-1.563548,-4.082763,4.842263,0.428771,0.682691,-2.650112,-5.003649,4.188483,0.374971,0.727805,-0.427049,-1.094134,7.360529,0.486717,0.547629,-0.496396,-0.475659,7.440358,0.485301,0.527395,-5.253307,3.881582,3.363159,0.257765,0.314490,-1.718698,0.974609,4.558359,0.401223,0.455172,-1.608635,-0.942516,5.814193,0.429819,0.548615,-1.651267,-0.610868,5.581319,0.421352,0.533741,-4.765501,-0.701554,3.534632,0.276896,0.532057,-0.478306,0.295766,7.101013,0.483370,0.499587,-3.734964,4.508230,4.550454,0.337212,0.282883,-4.588603,4.302037,4.048484,0.296392,0.293243,-6.279331,6.615427,1.425850,0.169295,0.193814,-1.220941,4.142165,5.106035,0.447580,0.302610,-2.193489,3.100317,4.000575,0.392390,0.353888,-3.102642,-4.352984,4.095905,0.354490,0.696784,-6.719682,-4.788645,-1.745401,0.067305,0.730105,-1.193824,-1.306795,5.737747,0.442739,0.572826,-0.729766,-1.593712,5.833208,0.457098,0.584792,-2.456206,-4.342621,4.283884,0.381974,0.694711,-2.204823,-4.304508,4.162499,0.392389,0.694203,-4.985894,4.802461,3.751977,0.277076,0.271932,-1.592294,-1.257709,5.456949,0.422552,0.563233,-2.644548,4.524654,4.921559,0.385919,0.281364,-2.760292,5.100971,5.015990,0.383103,0.255840,-3.523964,8.005976,3.729163,0.331431,0.119714,-5.599763,5.715470,2.724259,0.229924,0.232003,-3.063932,6.566144,4.529981,0.364501,0.189114,-5.720968,4.254584,2.830852,0.229622,0.299541,-6.374393,4.785590,1.591691,0.173287,0.278748,-0.672728,-3.688016,5.737804,0.472879,0.666198,-1.262560,-3.787691,5.417779,0.446828,0.668527,-1.732553,-3.952767,5.000579,0.422762,0.673890,-1.043625,-1.464973,5.662455,0.445308,0.580066,-2.321234,-4.329069,4.258156,0.388103,0.693961,-2.056846,-4.477671,4.520883,0.403039,0.706540,-2.153084,-4.276322,4.038093,0.403629,0.693953,-0.946874,-1.035249,6.512274,0.460042,0.557139,-1.469132,-4.036351,4.604908,0.431158,0.692366,-1.024340,-3.989851,4.926693,0.452182,0.692366,-0.533422,-3.993222,5.138202,0.475387,0.692366,-0.769720,-6.095394,4.985883,0.465828,0.779190,-0.699606,-5.291850,5.448304,0.472329,0.736226,-0.669687,-4.949770,5.509612,0.473087,0.717857,-0.630947,-4.695101,5.449371,0.473122,0.704626,-0.583218,-4.517982,5.339869,0.473033,0.695278,-1.537170,-4.423206,4.745470,0.427942,0.695278,-1.615600,-4.475942,4.813632,0.426479,0.703540,-1.729053,-4.618680,4.854463,0.423162,0.711846,-1.838624,-4.828746,4.823737,0.418309,0.720063,-2.368250,-3.106237,4.868096,0.390095,0.639573,-7.542244,-1.049282,-2.431321,0.013954,0.560034,0.000000,-1.724003,6.601390,0.499914,0.580147,-1.826614,-4.399531,4.399021,0.413200,0.695400,-1.929558,-4.411831,4.497052,0.409626,0.701823,-0.597442,-2.013686,5.866456,0.468080,0.601535,-1.405627,-1.714196,5.241087,0.422729,0.585985,-0.662449,-1.819321,5.863759,0.463080,0.593784,-2.342340,0.572222,4.294303,0.372120,0.473414,-3.327324,0.104863,4.113860,0.334562,0.496073,-1.726175,-0.919165,5.273355,0.411671,0.546965,-5.133204,7.485602,2.660442,0.242176,0.147676,-4.538641,6.319907,3.683424,0.290777,0.201446,-3.986562,5.109487,4.466315,0.327338,0.256527,-2.169681,-5.440433,4.455874,0.399510,0.748921,-1.395634,5.011963,5.316032,0.441728,0.261676,-1.619500,6.599217,4.921106,0.429765,0.187834,-1.891399,8.236377,4.274997,0.412198,0.108901,-4.195832,2.235205,3.375099,0.288955,0.398952,-5.733342,1.411738,2.431726,0.218937,0.435411,-1.859887,2.355757,3.843181,0.412782,0.398970,-4.988612,3.074654,3.083858,0.257135,0.355440,-1.303263,1.416453,4.831091,0.427685,0.437961,-1.305757,-0.672779,6.415959,0.448340,0.536936,-6.465170,0.937119,1.689873,0.178560,0.457554,-5.258659,0.945811,2.974312,0.247308,0.457194,-4.432338,0.722096,3.522615,0.286267,0.467675,-3.300681,0.861641,3.872784,0.332828,0.460712,-2.430178,1.131492,4.039035,0.368756,0.447207,-1.820731,1.467954,4.224124,0.398964,0.432655,-0.563221,2.307693,5.566789,0.476410,0.405806,-6.338145,-0.529279,1.881175,0.189241,0.523924,-5.587698,3.208071,2.687839,0.228962,0.348951,-0.242624,-1.462857,7.071491,0.490726,0.562401,-1.611251,0.339326,4.895421,0.404670,0.485133,-7.743095,2.364999,-2.005167,0.019469,0.401564,-1.391142,1.851048,4.448999,0.426243,0.420431,-1.785794,-0.978284,4.850470,0.396993,0.548797,-4.670959,2.664461,3.084075,0.266470,0.376977,-1.333970,-0.283761,6.097047,0.439121,0.518958,-7.270895,-2.890917,-2.252455,0.032314,0.644357,-1.856432,2.585245,3.757904,0.419054,0.387155,-0.923388,0.073076,6.671944,0.462783,0.505747,-5.000589,-6.135128,1.892523,0.238979,0.779745,-5.085276,-7.178590,0.714711,0.198221,0.831938,-7.159291,-0.811820,-0.072044,0.107550,0.540755,-5.843051,-5.248023,0.924091,0.183610,0.740257,-6.847258,3.662916,0.724695,0.134410,0.333683,-2.412942,-8.258853,4.119213,0.385764,0.883154,-0.179909,-1.689864,6.573301,0.490967,0.579378,-2.103655,-0.163946,4.566119,0.382385,0.508573,-6.407571,2.236021,1.560843,0.174399,0.397671,-3.670075,2.360153,3.635230,0.318785,0.396235,-3.177186,2.294265,3.775704,0.343364,0.400597,-2.196121,-4.598322,4.479786,0.396100,0.710217,-6.234883,-1.944430,1.663542,0.187885,0.588538,-1.292924,-9.295920,4.094063,0.430987,0.944065,-3.210651,-8.533278,2.802001,0.318993,0.898285,-4.068926,-7.993109,1.925119,0.266248,0.869701,0.000000,6.545390,5.027311,0.500023,0.190576,0.000000,-9.403378,4.264492,0.499977,0.954453,-2.724032,2.315802,3.777151,0.366170,0.398822,-2.288460,2.398891,3.697603,0.393207,0.395537,-1.998311,2.496547,3.689148,0.410373,0.391080,-6.130040,3.399261,2.038516,0.194993,0.342102,-2.288460,2.886504,3.775031,0.388665,0.362284,-2.724032,2.961810,3.871767,0.365962,0.355971,-3.177186,2.964136,3.876973,0.343364,0.355357,-3.670075,2.927714,3.724325,0.318785,0.358340,-4.018389,2.857357,3.482983,0.301415,0.363156,-7.555811,4.106811,-0.991917,0.058133,0.319076,-4.018389,2.483695,3.440898,0.301415,0.387449,0.000000,-2.521945,5.932265,0.499988,0.618434,-1.776217,-2.683946,5.213116,0.415838,0.624196,-1.222237,-1.182444,5.952465,0.445682,0.566077,-0.731493,-2.536683,5.815343,0.465844,0.620641,0.000000,3.271027,5.236015,0.499923,0.351524,-4.135272,-6.996638,2.671970,0.288719,0.819946,-3.311811,-7.660815,3.382963,0.335279,0.852820,-1.313701,-8.639995,4.702456,0.440512,0.902419,-5.940524,-6.223629,-0.631468,0.128294,0.791941,-1.998311,2.743838,3.744030,0.408772,0.373894,-0.901447,1.236992,5.754256,0.455607,0.451801,0.000000,-8.765243,4.891441,0.499877,0.908990,-2.308977,-8.974196,3.609070,0.375437,0.924192,-6.954154,-2.439843,-0.131163,0.114210,0.615022,-1.098819,-4.458788,5.120727,0.448662,0.695278,-1.181124,-4.579996,5.189564,0.448020,0.704632,-1.255818,-4.787901,5.237051,0.447112,0.715808,-1.325085,-5.106507,5.205010,0.444832,0.730794,-1.546388,-5.819392,4.757893,0.430012,0.766809,-1.953754,-4.183892,4.431713,0.406787,0.685673,-2.117802,-4.137093,4.555096,0.400738,0.681069,-2.285339,-4.051196,4.582438,0.392400,0.677703,-2.850160,-3.665720,4.484994,0.367856,0.663919,-5.278538,-2.238942,2.861224,0.247923,0.601333,-0.946709,1.907628,5.196779,0.452770,0.420850,-1.314173,3.104912,4.231404,0.436392,0.359887,-1.780000,2.860000,3.881555,0.416164,0.368714,-1.845110,-4.098880,4.247264,0.413386,0.692366,-5.436187,-4.030482,2.109852,0.228018,0.683572,-0.766444,3.182131,4.861453,0.468268,0.352671,-1.938616,-6.614410,4.521085,0.411362,0.804327,0.000000,1.059413,6.774605,0.499989,0.469825,-0.516573,1.583572,6.148363,0.479154,0.442654,0.000000,1.728369,6.316750,0.499974,0.439637,-1.246815,0.230297,5.681036,0.432112,0.493589,0.000000,-7.942194,5.181173,0.499886,0.866917,0.000000,-6.991499,5.153478,0.499913,0.821729,-0.997827,-6.930921,4.979576,0.456549,0.819201,-3.288807,-5.382514,3.795752,0.344549,0.745439,-2.311631,-1.566237,4.590085,0.378909,0.574010,-2.680250,-6.111567,4.096152,0.374293,0.780185,-3.832928,-1.537326,4.137731,0.319688,0.570738,-2.961860,-2.274215,4.440943,0.357155,0.604270,-4.386901,-2.683286,3.643886,0.295284,0.621581,-1.217295,-7.834465,4.969286,0.447750,0.862477,-1.542374,-0.136843,5.201008,0.410986,0.508723,-3.878377,-6.041764,3.311079,0.313951,0.775308,-3.084037,-6.809842,3.814195,0.354128,0.812553,-3.747321,-4.503545,3.726453,0.324548,0.703993,-6.094129,-3.205991,1.473482,0.189096,0.646300,-4.588995,-4.728726,2.983221,0.279777,0.714658,-6.583231,-3.941269,0.070268,0.133823,0.682701,-3.492580,-3.195820,4.130198,0.336768,0.644733,-1.255543,0.802341,5.307551,0.429884,0.466522,-1.126122,-0.933602,6.538785,0.455528,0.548623,-1.443109,-1.142774,5.905127,0.437114,0.558896,-0.923043,-0.529042,7.003423,0.467288,0.529925,-1.755386,3.529117,4.327696,0.414712,0.335220,-2.632589,3.713828,4.364629,0.377046,0.322778,-3.388062,3.721976,4.309028,0.344108,0.320151,-4.075766,3.675413,4.076063,0.312876,0.322332,-4.622910,3.474691,3.646321,0.283526,0.333190,-5.171755,2.535753,2.670867,0.241246,0.382786,-7.297331,0.763172,-0.048769,0.102986,0.468763,-4.706828,1.651000,3.109532,0.267612,0.424560,-4.071712,1.476821,3.476944,0.297879,0.433176,-3.269817,1.470659,3.731945,0.333434,0.433878,-2.527572,1.617311,3.865444,0.366427,0.426116,-1.970894,1.858505,3.961782,0.396012,0.416696,-1.579543,2.097941,4.084996,0.420121,0.410228,-7.664182,0.673132,-2.435867,0.007561,0.480777,-1.397041,-1.340139,5.630378,0.432949,0.569518,-0.884838,0.658740,6.233232,0.458639,0.479089,-0.767097,-0.968035,7.077932,0.473466,0.545744,-0.460213,-1.334106,6.787447,0.476088,0.563830,-0.748618,-1.067994,6.798303,0.468472,0.555057,-1.236408,-1.585568,5.480490,0.433991,0.582362,-0.387306,-1.409990,6.957705,0.483518,0.562984,-0.319925,-1.607931,6.508676,0.482483,0.577849,-1.639633,2.556298,3.863736,0.426450,0.389799,-1.255645,2.467144,4.203800,0.438999,0.396495,-1.031362,2.382663,4.615849,0.450067,0.400434,-4.253081,2.772296,3.315305,0.289712,0.368253,-4.530000,2.910000,3.339685,0.276670,0.363373,0.463928,0.955357,6.633583,0.517862,0.471948,4.253081,2.577646,3.279702,0.710288,0.380764,0.416106,-1.466449,6.447657,0.526227,0.573910,7.087960,5.434801,0.099620,0.895093,0.254141,2.628639,2.035898,3.848121,0.634070,0.409576,3.198363,1.985815,3.796952,0.661242,0.413025,3.775151,2.039402,3.646194,0.688880,0.409460,4.465819,2.422950,3.155168,0.725342,0.389131,2.164289,2.189867,3.851822,0.606630,0.403705,3.208229,3.223926,4.115822,0.654766,0.344011,2.673803,3.205337,4.092203,0.629906,0.346076,3.745193,3.165286,3.972409,0.680678,0.347265,4.161018,3.059069,3.719554,0.702097,0.353591,5.062006,1.934418,2.776093,0.752212,0.410805,2.266659,-7.425768,4.389812,0.602918,0.842863,4.445859,2.663991,3.173422,0.719902,0.375600,7.214530,2.263009,0.073150,0.893693,0.399960,5.799793,2.349546,2.204059,0.790082,0.391354,2.844939,-0.720868,4.433130,0.643998,0.534488,0.711452,-3.329355,5.877044,0.528249,0.650404,0.606033,-3.924562,5.444923,0.525850,0.680191,1.431615,-3.500953,5.496189,0.560215,0.657229,1.914910,-3.803146,5.028930,0.585384,0.666541,1.131043,-3.973937,5.189648,0.549626,0.680861,1.563548,-4.082763,4.842263,0.571228,0.682692,2.650112,-5.003649,4.188483,0.624852,0.728099,0.427049,-1.094134,7.360529,0.513050,0.547282,0.496396,-0.475659,7.440358,0.515097,0.527252,5.253307,3.881582,3.363159,0.742247,0.314507,1.718698,0.974609,4.558359,0.598631,0.454979,1.608635,-0.942516,5.814193,0.570338,0.548575,1.651267,-0.610868,5.581319,0.578632,0.533623,4.765501,-0.701554,3.534632,0.723087,0.532054,0.478306,0.295766,7.101013,0.516446,0.499639,3.734964,4.508230,4.550454,0.662801,0.282918,4.588603,4.302037,4.048484,0.703624,0.293271,6.279331,6.615427,1.425850,0.830705,0.193814,1.220941,4.142165,5.106035,0.552386,0.302568,2.193489,3.100317,4.000575,0.607610,0.353888,3.102642,-4.352984,4.095905,0.645429,0.696707,6.719682,-4.788645,-1.745401,0.932695,0.730105,1.193824,-1.306795,5.737747,0.557261,0.572826,0.729766,-1.593712,5.833208,0.542902,0.584792,2.456206,-4.342621,4.283884,0.618026,0.694711,2.204823,-4.304508,4.162499,0.607591,0.694203,4.985894,4.802461,3.751977,0.722943,0.271963,1.592294,-1.257709,5.456949,0.577414,0.563167,2.644548,4.524654,4.921559,0.614083,0.281387,2.760292,5.100971,5.015990,0.616907,0.255886,3.523964,8.005976,3.729163,0.668509,0.119914,5.599763,5.715470,2.724259,0.770092,0.232021,3.063932,6.566144,4.529981,0.635536,0.189249,5.720968,4.254584,2.830852,0.770391,0.299556,6.374393,4.785590,1.591691,0.826722,0.278755,0.672728,-3.688016,5.737804,0.527121,0.666198,1.262560,-3.787691,5.417779,0.553172,0.668527,1.732553,-3.952767,5.000579,0.577238,0.673890,1.043625,-1.464973,5.662455,0.554692,0.580066,2.321234,-4.329069,4.258156,0.611897,0.693961,2.056846,-4.477671,4.520883,0.596961,0.706540,2.153084,-4.276322,4.038093,0.596371,0.693953,0.946874,-1.035249,6.512274,0.539958,0.557139,1.469132,-4.036351,4.604908,0.568842,0.692366,1.024340,-3.989851,4.926693,0.547818,0.692366,0.533422,-3.993222,5.138202,0.524613,0.692366,0.769720,-6.095394,4.985883,0.534090,0.779141,0.699606,-5.291850,5.448304,0.527671,0.736226,0.669687,-4.949770,5.509612,0.526913,0.717857,0.630947,-4.695101,5.449371,0.526878,0.704626,0.583218,-4.517982,5.339869,0.526967,0.695278,1.537170,-4.423206,4.745470,0.572058,0.695278,1.615600,-4.475942,4.813632,0.573521,0.703540,1.729053,-4.618680,4.854463,0.576838,0.711846,1.838624,-4.828746,4.823737,0.581691,0.720063,2.368250,-3.106237,4.868096,0.609945,0.639910,7.542244,-1.049282,-2.431321,0.986046,0.560034,1.826614,-4.399531,4.399021,0.586800,0.695400,1.929558,-4.411831,4.497052,0.590372,0.701823,0.597442,-2.013686,5.866456,0.531915,0.601537,1.405627,-1.714196,5.241087,0.577268,0.585935,0.662449,-1.819321,5.863759,0.536915,0.593786,2.342340,0.572222,4.294303,0.627543,0.473352,3.327324,0.104863,4.113860,0.665586,0.495951,1.726175,-0.919165,5.273355,0.588354,0.546862,5.133204,7.485602,2.660442,0.757824,0.147676,4.538641,6.319907,3.683424,0.709250,0.201508,3.986562,5.109487,4.466315,0.672684,0.256581,2.169681,-5.440433,4.455874,0.600409,0.749005,1.395634,5.011963,5.316032,0.558266,0.261672,1.619500,6.599217,4.921106,0.570304,0.187871,1.891399,8.236377,4.274997,0.588166,0.109044,4.195832,2.235205,3.375099,0.711045,0.398952,5.733342,1.411738,2.431726,0.781070,0.435405,1.859887,2.355757,3.843181,0.587247,0.398932,4.988612,3.074654,3.083858,0.742870,0.355446,1.303263,1.416453,4.831091,0.572156,0.437652,1.305757,-0.672779,6.415959,0.551868,0.536570,6.465170,0.937119,1.689873,0.821442,0.457556,5.258659,0.945811,2.974312,0.752702,0.457182,4.432338,0.722096,3.522615,0.713757,0.467627,3.300681,0.861641,3.872784,0.667113,0.460673,2.430178,1.131492,4.039035,0.631101,0.447154,1.820731,1.467954,4.224124,0.600862,0.432473,0.563221,2.307693,5.566789,0.523481,0.405627,6.338145,-0.529279,1.881175,0.810748,0.523926,5.587698,3.208071,2.687839,0.771046,0.348959,0.242624,-1.462857,7.071491,0.509127,0.562718,1.611251,0.339326,4.895421,0.595293,0.485024,7.743095,2.364999,-2.005167,0.980531,0.401564,1.391142,1.851048,4.448999,0.573500,0.420000,1.785794,-0.978284,4.850470,0.602995,0.548688,4.670959,2.664461,3.084075,0.733530,0.376977,1.333970,-0.283761,6.097047,0.560611,0.519017,7.270895,-2.890917,-2.252455,0.967686,0.644357,1.856432,2.585245,3.757904,0.580985,0.387160,0.923388,0.073076,6.671944,0.537728,0.505385,5.000589,-6.135128,1.892523,0.760966,0.779753,5.085276,-7.178590,0.714711,0.801779,0.831938,7.159291,-0.811820,-0.072044,0.892441,0.540761,5.843051,-5.248023,0.924091,0.816351,0.740260,6.847258,3.662916,0.724695,0.865595,0.333687,2.412942,-8.258853,4.119213,0.614074,0.883246,0.179909,-1.689864,6.573301,0.508953,0.579438,2.103655,-0.163946,4.566119,0.617942,0.508316,6.407571,2.236021,1.560843,0.825608,0.397675,3.670075,2.360153,3.635230,0.681215,0.396235,3.177186,2.294265,3.775704,0.656636,0.400597,2.196121,-4.598322,4.479786,0.603900,0.710217,6.234883,-1.944430,1.663542,0.812086,0.588539,1.292924,-9.295920,4.094063,0.568013,0.944565,3.210651,-8.533278,2.802001,0.681008,0.898285,4.068926,-7.993109,1.925119,0.733752,0.869701,2.724032,2.315802,3.777151,0.633830,0.398822,2.288460,2.398891,3.697603,0.606793,0.395537,1.998311,2.496547,3.689148,0.589660,0.391062,6.130040,3.399261,2.038516,0.805016,0.342108,2.288460,2.886504,3.775031,0.611335,0.362284,2.724032,2.961810,3.871767,0.634038,0.355971,3.177186,2.964136,3.876973,0.656636,0.355357,3.670075,2.927714,3.724325,0.681215,0.358340,4.018389,2.857357,3.482983,0.698585,0.363156,7.555811,4.106811,-0.991917,0.941867,0.319076,4.018389,2.483695,3.440898,0.698585,0.387449,1.776217,-2.683946,5.213116,0.584177,0.624107,1.222237,-1.182444,5.952465,0.554318,0.566077,0.731493,-2.536683,5.815343,0.534154,0.620640,4.135272,-6.996638,2.671970,0.711218,0.819975,3.311811,-7.660815,3.382963,0.664630,0.852871,1.313701,-8.639995,4.702456,0.559100,0.902632,5.940524,-6.223629,-0.631468,0.871706,0.791941,1.998311,2.743838,3.744030,0.591234,0.373894,0.901447,1.236992,5.754256,0.544341,0.451584,2.308977,-8.974196,3.609070,0.624563,0.924192,6.954154,-2.439843,-0.131163,0.885770,0.615029,1.098819,-4.458788,5.120727,0.551338,0.695278,1.181124,-4.579996,5.189564,0.551980,0.704632,1.255818,-4.787901,5.237051,0.552888,0.715808,1.325085,-5.106507,5.205010,0.555168,0.730794,1.546388,-5.819392,4.757893,0.569944,0.767035,1.953754,-4.183892,4.431713,0.593203,0.685676,2.117802,-4.137093,4.555096,0.599262,0.681069,2.285339,-4.051196,4.582438,0.607600,0.677703,2.850160,-3.665720,4.484994,0.631938,0.663500,5.278538,-2.238942,2.861224,0.752033,0.601315,0.946709,1.907628,5.196779,0.547226,0.420395,1.314173,3.104912,4.231404,0.563544,0.359828,1.780000,2.860000,3.881555,0.583841,0.368714,1.845110,-4.098880,4.247264,0.586614,0.692366,5.436187,-4.030482,2.109852,0.771915,0.683578,0.766444,3.182131,4.861453,0.531597,0.352483,1.938616,-6.614410,4.521085,0.588371,0.804441,0.516573,1.583572,6.148363,0.520797,0.442565,1.246815,0.230297,5.681036,0.567985,0.493479,0.997827,-6.930921,4.979576,0.543283,0.819255,3.288807,-5.382514,3.795752,0.655317,0.745515,2.311631,-1.566237,4.590085,0.621009,0.574018,2.680250,-6.111567,4.096152,0.625560,0.780312,3.832928,-1.537326,4.137731,0.680198,0.570719,2.961860,-2.274215,4.440943,0.642764,0.604338,4.386901,-2.683286,3.643886,0.704663,0.621530,1.217295,-7.834465,4.969286,0.552012,0.862592,1.542374,-0.136843,5.201008,0.589072,0.508637,3.878377,-6.041764,3.311079,0.685945,0.775357,3.084037,-6.809842,3.814195,0.645735,0.812640,3.747321,-4.503545,3.726453,0.675343,0.703978,6.094129,-3.205991,1.473482,0.810858,0.646305,4.588995,-4.728726,2.983221,0.720122,0.714667,6.583231,-3.941269,0.070268,0.866152,0.682705,3.492580,-3.195820,4.130198,0.663187,0.644597,1.255543,0.802341,5.307551,0.570082,0.466326,1.126122,-0.933602,6.538785,0.544562,0.548376,1.443109,-1.142774,5.905127,0.562759,0.558785,0.923043,-0.529042,7.003423,0.531987,0.530140,1.755386,3.529117,4.327696,0.585271,0.335177,2.632589,3.713828,4.364629,0.622953,0.322779,3.388062,3.721976,4.309028,0.655896,0.320163,4.075766,3.675413,4.076063,0.687132,0.322346,4.622910,3.474691,3.646321,0.716482,0.333201,5.171755,2.535753,2.670867,0.758757,0.382787,7.297331,0.763172,-0.048769,0.897013,0.468769,4.706828,1.651000,3.109532,0.732392,0.424547,4.071712,1.476821,3.476944,0.702114,0.433163,3.269817,1.470659,3.731945,0.666525,0.433866,2.527572,1.617311,3.865444,0.633505,0.426088,1.970894,1.858505,3.961782,0.603876,0.416587,1.579543,2.097941,4.084996,0.579658,0.409945,7.664182,0.673132,-2.435867,0.992440,0.480777,1.397041,-1.340139,5.630378,0.567192,0.569420,0.884838,0.658740,6.233232,0.541366,0.478899,0.767097,-0.968035,7.077932,0.526564,0.546118,0.460213,-1.334106,6.787447,0.523913,0.563830,0.748618,-1.067994,6.798303,0.531529,0.555057,1.236408,-1.585568,5.480490,0.566036,0.582329,0.387306,-1.409990,6.957705,0.516311,0.563054,0.319925,-1.607931,6.508676,0.517472,0.577877,1.639633,2.556298,3.863736,0.573595,0.389807,1.255645,2.467144,4.203800,0.560698,0.395332,1.031362,2.382663,4.615849,0.549756,0.399751,4.253081,2.772296,3.315305,0.710288,0.368253,4.530000,2.910000,3.339685,0.723330,0.363373])
canonical_metric_landmarks = np.reshape(canonical_metric_landmarks,(canonical_metric_landmarks.shape[0]//5,5)).T
canonical_metric_landmarks = canonical_metric_landmarks[:3,:]

procrustes_landmark_basis = [(4,0.070909939706326),(6,0.032100144773722),(10,0.008446550928056),(33,0.058724168688059),(54,0.007667080033571),(67,0.009078059345484),(117,0.009791937656701),(119,0.014565368182957),(121,0.018591361120343),(127,0.005197994410992),(129,0.120625205338001),(132,0.005560018587857),(133,0.05328618362546),(136,0.066890455782413),(143,0.014816547743976),(147,0.014262833632529),(198,0.025462191551924),(205,0.047252278774977),(263,0.058724168688059),(284,0.007667080033571),(297,0.009078059345484),(346,0.009791937656701),(348,0.014565368182957),(350,0.018591361120343),(356,0.005197994410992),(358,0.120625205338001),(361,0.005560018587857),(362,0.05328618362546),(365,0.066890455782413),(372,0.014816547743976),(376,0.014262833632529),(420,0.025462191551924),(425,0.047252278774977)]
landmark_weights = np.zeros((canonical_metric_landmarks.shape[1],))
for idx, weight in procrustes_landmark_basis:
    landmark_weights[idx] = weight

canonical_indices = [[173, 155, 133], [246, 33, 7], [382, 398, 362], [263, 466, 249], [308, 415, 324], [78, 95, 191], [356, 389, 264], [127, 34, 162], [368, 264, 389], [139, 162, 34], [267, 0, 302], [37, 72, 0], [11, 302, 0], [11, 0, 72], [349, 451, 350], [120, 121, 231], [452, 350, 451], [232, 231, 121], [267, 302, 269], [37, 39, 72], [303, 269, 302], [73, 72, 39], [357, 343, 350], [128, 121, 114], [277, 350, 343], [47, 114, 121], [350, 452, 357], [121, 128, 232], [453, 357, 452], [233, 232, 128], [299, 333, 297], [69, 67, 104], [332, 297, 333], [103, 104, 67], [175, 152, 396], [175, 171, 152], [377, 396, 152], [148, 152, 171], [381, 384, 382], [154, 155, 157], [398, 382, 384], [173, 157, 155], [280, 347, 330], [50, 101, 118], [348, 330, 347], [119, 118, 101], [269, 303, 270], [39, 40, 73], [304, 270, 303], [74, 73, 40], [9, 336, 151], [9, 151, 107], [337, 151, 336], [108, 107, 151], [344, 278, 360], [115, 131, 48], [279, 360, 278], [49, 48, 131], [262, 431, 418], [32, 194, 211], [424, 418, 431], [204, 211, 194], [304, 408, 270], [74, 40, 184], [409, 270, 408], [185, 184, 40], [272, 310, 407], [42, 183, 80], [415, 407, 310], [191, 80, 183], [322, 270, 410], [92, 186, 40], [409, 410, 270], [185, 40, 186], [347, 449, 348], [118, 119, 229], [450, 348, 449], [230, 229, 119], [434, 432, 430], [214, 210, 212], [422, 430, 432], [202, 212, 210], [313, 314, 18], [83, 18, 84], [17, 18, 314], [17, 84, 18], [307, 375, 306], [77, 76, 146], [291, 306, 375], [61, 146, 76], [259, 387, 260], [29, 30, 160], [388, 260, 387], [161, 160, 30], [286, 414, 384], [56, 157, 190], [398, 384, 414], [173, 190, 157], [418, 424, 406], [194, 182, 204], [335, 406, 424], [106, 204, 182], [367, 416, 364], [138, 135, 192], [434, 364, 416], [214, 192, 135], [391, 423, 327], [165, 98, 203], [358, 327, 423], [129, 203, 98], [298, 301, 284], [68, 54, 71], [251, 284, 301], [21, 71, 54], [4, 275, 5], [4, 5, 45], [281, 5, 275], [51, 45, 5], [254, 373, 253], [24, 23, 144], [374, 253, 373], [145, 144, 23], [320, 321, 307], [90, 77, 91], [375, 307, 321], [146, 91, 77], [280, 425, 411], [50, 187, 205], [427, 411, 425], [207, 205, 187], [421, 313, 200], [201, 200, 83], [18, 200, 313], [18, 83, 200], [335, 321, 406], [106, 182, 91], [405, 406, 321], [181, 91, 182], [405, 321, 404], [181, 180, 91], [320, 404, 321], [90, 91, 180], [17, 314, 16], [17, 16, 84], [315, 16, 314], [85, 84, 16], [425, 266, 426], [205, 206, 36], [423, 426, 266], [203, 36, 206], [369, 396, 400], [140, 176, 171], [377, 400, 396], [148, 171, 176], [391, 269, 322], [165, 92, 39], [270, 322, 269], [40, 39, 92], [417, 465, 413], [193, 189, 245], [464, 413, 465], [244, 245, 189], [257, 258, 386], [27, 159, 28], [385, 386, 258], [158, 28, 159], [260, 388, 467], [30, 247, 161], [466, 467, 388], [246, 161, 247], [248, 456, 419], [3, 196, 236], [399, 419, 456], [174, 236, 196], [333, 298, 332], [104, 103, 68], [284, 332, 298], [54, 68, 103], [285, 8, 417], [55, 193, 8], [168, 417, 8], [168, 8, 193], [340, 261, 346], [111, 117, 31], [448, 346, 261], [228, 31, 117], [285, 417, 441], [55, 221, 193], [413, 441, 417], [189, 193, 221], [327, 460, 326], [98, 97, 240], [328, 326, 460], [99, 240, 97], [277, 355, 329], [47, 100, 126], [371, 329, 355], [142, 126, 100], [309, 392, 438], [79, 218, 166], [439, 438, 392], [219, 166, 218], [381, 382, 256], [154, 26, 155], [341, 256, 382], [112, 155, 26], [360, 279, 420], [131, 198, 49], [429, 420, 279], [209, 49, 198], [365, 364, 379], [136, 150, 135], [394, 379, 364], [169, 135, 150], [355, 277, 437], [126, 217, 47], [343, 437, 277], [114, 47, 217], [443, 444, 282], [223, 52, 224], [283, 282, 444], [53, 224, 52], [281, 275, 363], [51, 134, 45], [440, 363, 275], [220, 45, 134], [431, 262, 395], [211, 170, 32], [369, 395, 262], [140, 32, 170], [337, 299, 338], [108, 109, 69], [297, 338, 299], [67, 69, 109], [335, 273, 321], [106, 91, 43], [375, 321, 273], [146, 43, 91], [348, 450, 349], [119, 120, 230], [451, 349, 450], [231, 230, 120], [467, 359, 342], [247, 113, 130], [446, 342, 359], [226, 130, 113], [282, 283, 334], [52, 105, 53], [293, 334, 283], [63, 53, 105], [250, 458, 462], [20, 242, 238], [461, 462, 458], [241, 238, 242], [276, 353, 300], [46, 70, 124], [383, 300, 353], [156, 124, 70], [325, 292, 324], [96, 95, 62], [308, 324, 292], [78, 62, 95], [283, 276, 293], [53, 63, 46], [300, 293, 276], [70, 46, 63], [447, 264, 345], [227, 116, 34], [372, 345, 264], [143, 34, 116], [352, 345, 346], [123, 117, 116], [340, 346, 345], [111, 116, 117], [1, 19, 274], [1, 44, 19], [354, 274, 19], [125, 19, 44], [248, 281, 456], [3, 236, 51], [363, 456, 281], [134, 51, 236], [425, 426, 427], [205, 207, 206], [436, 427, 426], [216, 206, 207], [380, 381, 252], [153, 22, 154], [256, 252, 381], [26, 154, 22], [391, 393, 269], [165, 39, 167], [267, 269, 393], [37, 167, 39], [199, 428, 200], [199, 200, 208], [421, 200, 428], [201, 208, 200], [330, 329, 266], [101, 36, 100], [371, 266, 329], [142, 100, 36], [422, 432, 273], [202, 43, 212], [287, 273, 432], [57, 212, 43], [290, 250, 328], [60, 99, 20], [462, 328, 250], [242, 20, 99], [258, 286, 385], [28, 158, 56], [384, 385, 286], [157, 56, 158], [342, 446, 353], [113, 124, 226], [265, 353, 446], [35, 226, 124], [257, 386, 259], [27, 29, 159], [387, 259, 386], [160, 159, 29], [430, 422, 431], [210, 211, 202], [424, 431, 422], [204, 202, 211], [445, 342, 276], [225, 46, 113], [353, 276, 342], [124, 113, 46], [424, 422, 335], [204, 106, 202], [273, 335, 422], [43, 202, 106], [306, 292, 307], [76, 77, 62], [325, 307, 292], [96, 62, 77], [366, 447, 352], [137, 123, 227], [345, 352, 447], [116, 227, 123], [302, 268, 303], [72, 73, 38], [271, 303, 268], [41, 38, 73], [371, 358, 266], [142, 36, 129], [423, 266, 358], [203, 129, 36], [327, 294, 460], [98, 240, 64], [455, 460, 294], [235, 64, 240], [294, 331, 278], [64, 48, 102], [279, 278, 331], [49, 102, 48], [303, 271, 304], [73, 74, 41], [272, 304, 271], [42, 41, 74], [427, 436, 434], [207, 214, 216], [432, 434, 436], [212, 216, 214], [304, 272, 408], [74, 184, 42], [407, 408, 272], [183, 42, 184], [394, 430, 395], [169, 170, 210], [431, 395, 430], [211, 210, 170], [395, 369, 378], [170, 149, 140], [400, 378, 369], [176, 140, 149], [296, 334, 299], [66, 69, 105], [333, 299, 334], [104, 105, 69], [417, 168, 351], [193, 122, 168], [6, 351, 168], [6, 168, 122], [280, 411, 352], [50, 123, 187], [376, 352, 411], [147, 187, 123], [319, 320, 325], [89, 96, 90], [307, 325, 320], [77, 90, 96], [285, 295, 336], [55, 107, 65], [296, 336, 295], [66, 65, 107], [404, 320, 403], [180, 179, 90], [319, 403, 320], [89, 90, 179], [330, 348, 329], [101, 100, 119], [349, 329, 348], [120, 119, 100], [334, 293, 333], [105, 104, 63], [298, 333, 293], [68, 63, 104], [323, 454, 366], [93, 137, 234], [447, 366, 454], [227, 234, 137], [16, 315, 15], [16, 15, 85], [316, 15, 315], [86, 85, 15], [429, 279, 358], [209, 129, 49], [331, 358, 279], [102, 49, 129], [15, 316, 14], [15, 14, 86], [317, 14, 316], [87, 86, 14], [8, 285, 9], [8, 9, 55], [336, 9, 285], [107, 55, 9], [329, 349, 277], [100, 47, 120], [350, 277, 349], [121, 120, 47], [252, 253, 380], [22, 153, 23], [374, 380, 253], [145, 23, 153], [402, 403, 318], [178, 88, 179], [319, 318, 403], [89, 179, 88], [351, 6, 419], [122, 196, 6], [197, 419, 6], [197, 6, 196], [324, 318, 325], [95, 96, 88], [319, 325, 318], [89, 88, 96], [397, 367, 365], [172, 136, 138], [364, 365, 367], [135, 138, 136], [288, 435, 397], [58, 172, 215], [367, 397, 435], [138, 215, 172], [438, 439, 344], [218, 115, 219], [278, 344, 439], [48, 219, 115], [271, 311, 272], [41, 42, 81], [310, 272, 311], [80, 81, 42], [5, 281, 195], [5, 195, 51], [248, 195, 281], [3, 51, 195], [273, 287, 375], [43, 146, 57], [291, 375, 287], [61, 57, 146], [396, 428, 175], [171, 175, 208], [199, 175, 428], [199, 208, 175], [268, 312, 271], [38, 41, 82], [311, 271, 312], [81, 82, 41], [444, 445, 283], [224, 53, 225], [276, 283, 445], [46, 225, 53], [254, 339, 373], [24, 144, 110], [390, 373, 339], [163, 110, 144], [295, 282, 296], [65, 66, 52], [334, 296, 282], [105, 52, 66], [346, 448, 347], [117, 118, 228], [449, 347, 448], [229, 228, 118], [454, 356, 447], [234, 227, 127], [264, 447, 356], [34, 127, 227], [336, 296, 337], [107, 108, 66], [299, 337, 296], [69, 66, 108], [151, 337, 10], [151, 10, 108], [338, 10, 337], [109, 108, 10], [278, 439, 294], [48, 64, 219], [455, 294, 439], [235, 219, 64], [407, 415, 292], [183, 62, 191], [308, 292, 415], [78, 191, 62], [358, 371, 429], [129, 209, 142], [355, 429, 371], [126, 142, 209], [345, 372, 340], [116, 111, 143], [265, 340, 372], [35, 143, 111], [388, 390, 466], [161, 246, 163], [249, 466, 390], [7, 163, 246], [352, 346, 280], [123, 50, 117], [347, 280, 346], [118, 117, 50], [295, 442, 282], [65, 52, 222], [443, 282, 442], [223, 222, 52], [19, 94, 354], [19, 125, 94], [370, 354, 94], [141, 94, 125], [295, 285, 442], [65, 222, 55], [441, 442, 285], [221, 55, 222], [419, 197, 248], [196, 3, 197], [195, 248, 197], [195, 197, 3], [359, 263, 255], [130, 25, 33], [249, 255, 263], [7, 33, 25], [275, 274, 440], [45, 220, 44], [457, 440, 274], [237, 44, 220], [300, 383, 301], [70, 71, 156], [368, 301, 383], [139, 156, 71], [417, 351, 465], [193, 245, 122], [412, 465, 351], [188, 122, 245], [466, 263, 467], [246, 247, 33], [359, 467, 263], [130, 33, 247], [389, 251, 368], [162, 139, 21], [301, 368, 251], [71, 21, 139], [374, 386, 380], [145, 153, 159], [385, 380, 386], [158, 159, 153], [379, 394, 378], [150, 149, 169], [395, 378, 394], [170, 169, 149], [351, 419, 412], [122, 188, 196], [399, 412, 419], [174, 196, 188], [426, 322, 436], [206, 216, 92], [410, 436, 322], [186, 92, 216], [387, 373, 388], [160, 161, 144], [390, 388, 373], [163, 144, 161], [393, 326, 164], [167, 164, 97], [2, 164, 326], [2, 97, 164], [354, 370, 461], [125, 241, 141], [462, 461, 370], [242, 141, 241], [0, 267, 164], [0, 164, 37], [393, 164, 267], [167, 37, 164], [11, 12, 302], [11, 72, 12], [268, 302, 12], [38, 12, 72], [386, 374, 387], [159, 160, 145], [373, 387, 374], [144, 145, 160], [12, 13, 268], [12, 38, 13], [312, 268, 13], [82, 13, 38], [293, 300, 298], [63, 68, 70], [301, 298, 300], [71, 70, 68], [340, 265, 261], [111, 31, 35], [446, 261, 265], [226, 35, 31], [380, 385, 381], [153, 154, 158], [384, 381, 385], [157, 158, 154], [280, 330, 425], [50, 205, 101], [266, 425, 330], [36, 101, 205], [423, 391, 426], [203, 206, 165], [322, 426, 391], [92, 165, 206], [429, 355, 420], [209, 198, 126], [437, 420, 355], [217, 126, 198], [391, 327, 393], [165, 167, 98], [326, 393, 327], [97, 98, 167], [457, 438, 440], [237, 220, 218], [344, 440, 438], [115, 218, 220], [382, 362, 341], [155, 112, 133], [463, 341, 362], [243, 133, 112], [457, 461, 459], [237, 239, 241], [458, 459, 461], [238, 241, 239], [434, 430, 364], [214, 135, 210], [394, 364, 430], [169, 210, 135], [414, 463, 398], [190, 173, 243], [362, 398, 463], [133, 243, 173], [262, 428, 369], [32, 140, 208], [396, 369, 428], [171, 208, 140], [457, 274, 461], [237, 241, 44], [354, 461, 274], [125, 44, 241], [316, 403, 317], [86, 87, 179], [402, 317, 403], [178, 179, 87], [315, 404, 316], [85, 86, 180], [403, 316, 404], [179, 180, 86], [314, 405, 315], [84, 85, 181], [404, 315, 405], [180, 181, 85], [313, 406, 314], [83, 84, 182], [405, 314, 406], [181, 182, 84], [418, 406, 421], [194, 201, 182], [313, 421, 406], [83, 182, 201], [366, 401, 323], [137, 93, 177], [361, 323, 401], [132, 177, 93], [408, 407, 306], [184, 76, 183], [292, 306, 407], [62, 183, 76], [408, 306, 409], [184, 185, 76], [291, 409, 306], [61, 76, 185], [410, 409, 287], [186, 57, 185], [291, 287, 409], [61, 185, 57], [436, 410, 432], [216, 212, 186], [287, 432, 410], [57, 186, 212], [434, 416, 427], [214, 207, 192], [411, 427, 416], [187, 192, 207], [264, 368, 372], [34, 143, 139], [383, 372, 368], [156, 139, 143], [457, 459, 438], [237, 218, 239], [309, 438, 459], [79, 239, 218], [352, 376, 366], [123, 137, 147], [401, 366, 376], [177, 147, 137], [4, 1, 275], [4, 45, 1], [274, 275, 1], [44, 1, 45], [428, 262, 421], [208, 201, 32], [418, 421, 262], [194, 32, 201], [327, 358, 294], [98, 64, 129], [331, 294, 358], [102, 129, 64], [367, 435, 416], [138, 192, 215], [433, 416, 435], [213, 215, 192], [455, 439, 289], [235, 59, 219], [392, 289, 439], [166, 219, 59], [328, 462, 326], [99, 97, 242], [370, 326, 462], [141, 242, 97], [326, 370, 2], [97, 2, 141], [94, 2, 370], [94, 141, 2], [460, 455, 305], [240, 75, 235], [289, 305, 455], [59, 235, 75], [448, 339, 449], [228, 229, 110], [254, 449, 339], [24, 110, 229], [261, 446, 255], [31, 25, 226], [359, 255, 446], [130, 226, 25], [449, 254, 450], [229, 230, 24], [253, 450, 254], [23, 24, 230], [450, 253, 451], [230, 231, 23], [252, 451, 253], [22, 23, 231], [451, 252, 452], [231, 232, 22], [256, 452, 252], [26, 22, 232], [256, 341, 452], [26, 232, 112], [453, 452, 341], [233, 112, 232], [413, 464, 414], [189, 190, 244], [463, 414, 464], [243, 244, 190], [441, 413, 286], [221, 56, 189], [414, 286, 413], [190, 189, 56], [441, 286, 442], [221, 222, 56], [258, 442, 286], [28, 56, 222], [442, 258, 443], [222, 223, 28], [257, 443, 258], [27, 28, 223], [444, 443, 259], [224, 29, 223], [257, 259, 443], [27, 223, 29], [259, 260, 444], [29, 224, 30], [445, 444, 260], [225, 30, 224], [260, 467, 445], [30, 225, 247], [342, 445, 467], [113, 247, 225], [250, 309, 458], [20, 238, 79], [459, 458, 309], [239, 79, 238], [290, 305, 392], [60, 166, 75], [289, 392, 305], [59, 75, 166], [460, 305, 328], [240, 99, 75], [290, 328, 305], [60, 75, 99], [376, 433, 401], [147, 177, 213], [435, 401, 433], [215, 213, 177], [250, 290, 309], [20, 79, 60], [392, 309, 290], [166, 60, 79], [411, 416, 376], [187, 147, 192], [433, 376, 416], [213, 192, 147], [341, 463, 453], [112, 233, 243], [464, 453, 463], [244, 243, 233], [453, 464, 357], [233, 128, 244], [465, 357, 464], [245, 244, 128], [412, 343, 465], [188, 245, 114], [357, 465, 343], [128, 114, 245], [437, 343, 399], [217, 174, 114], [412, 399, 343], [188, 114, 174], [363, 440, 360], [134, 131, 220], [344, 360, 440], [115, 220, 131], [456, 420, 399], [236, 174, 198], [437, 399, 420], [217, 198, 174], [456, 363, 420], [236, 198, 134], [360, 420, 363], [131, 134, 198], [361, 401, 288], [132, 58, 177], [435, 288, 401], [215, 177, 58], [353, 265, 383], [124, 156, 35], [372, 383, 265], [143, 35, 156], [255, 249, 339], [25, 110, 7], [390, 339, 249], [163, 7, 110], [261, 255, 448], [31, 228, 25], [339, 448, 255], [110, 25, 228], [14, 317, 13], [14, 13, 87], [312, 13, 317], [82, 87, 13], [317, 402, 312], [87, 82, 178], [311, 312, 402], [81, 178, 82], [402, 318, 311], [178, 81, 88], [310, 311, 318], [80, 88, 81], [318, 324, 310], [88, 80, 95], [415, 310, 324], [191, 95, 80]]

canonical_uvs = [[0.4999769926071167, 0.34746599197387695], [0.5000259876251221, 0.4525130093097687], [0.49997401237487793, 0.3976280093193054], [0.4821130037307739, 0.528020977973938], [0.5001509785652161, 0.4728440046310425], [0.49990999698638916, 0.5017470121383667], [0.49952301383018494, 0.59893798828125], [0.28971201181411743, 0.6192359924316406], [0.4999549984931946, 0.6876019835472107], [0.49998700618743896, 0.7300810217857361], [0.5000230073928833, 0.8929499983787537], [0.5000230073928833, 0.33376601338386536], [0.5000159740447998, 0.32077598571777344], [0.5000230073928833, 0.30765199661254883], [0.4999769926071167, 0.30472201108932495], [0.4999769926071167, 0.29406601190567017], [0.4999769926071167, 0.2806150019168854], [0.4999769926071167, 0.26298099756240845], [0.4999679923057556, 0.21862900257110596], [0.49981600046157837, 0.4370189905166626], [0.4737730026245117, 0.4260900020599365], [0.10490699857473373, 0.7458590269088745], [0.3659299910068512, 0.5904240012168884], [0.3387579917907715, 0.5869749784469604], [0.31112000346183777, 0.5905399918556213], [0.2746579945087433, 0.6108689904212952], [0.39336198568344116, 0.5962939858436584], [0.3452340066432953, 0.6559889912605286], [0.3700940012931824, 0.6539239883422852], [0.31932199001312256, 0.6527349948883057], [0.29790300130844116, 0.6464089751243591], [0.24779200553894043, 0.5891900062561035], [0.39688900113105774, 0.1572449952363968], [0.28009799122810364, 0.6244000196456909], [0.10631000250577927, 0.6000440120697021], [0.20992499589920044, 0.6086469888687134], [0.35580798983573914, 0.46559399366378784], [0.47175100445747375, 0.3495959937572479], [0.4741550087928772, 0.3198080062866211], [0.4397850036621094, 0.3427709937095642], [0.41461700201034546, 0.3334589898586273], [0.4503740072250366, 0.3191390037536621], [0.4287709891796112, 0.3173089921474457], [0.3749710023403168, 0.2721950113773346], [0.48671698570251465, 0.4523710012435913], [0.4853009879589081, 0.47260499000549316], [0.257764995098114, 0.685509979724884], [0.40122300386428833, 0.5448279976844788], [0.4298189878463745, 0.4513849914073944], [0.42135199904441833, 0.4662590026855469], [0.27689599990844727, 0.467943012714386], [0.48337000608444214, 0.5004130005836487], [0.3372119963169098, 0.7171170115470886], [0.2963919937610626, 0.7067570090293884], [0.16929499804973602, 0.8061860203742981], [0.4475800096988678, 0.6973900198936462], [0.39239001274108887, 0.6461120247840881], [0.3544900119304657, 0.30321601033210754], [0.06730499863624573, 0.2698949873447418], [0.44273900985717773, 0.42717400193214417], [0.45709800720214844, 0.41520801186561584], [0.3819740116596222, 0.30528900027275085], [0.3923889994621277, 0.3057970106601715], [0.27707600593566895, 0.7280679941177368], [0.4225519895553589, 0.43676701188087463], [0.3859190046787262, 0.7186359763145447], [0.38310301303863525, 0.744159996509552], [0.33143100142478943, 0.8802859783172607], [0.22992399334907532, 0.7679970264434814], [0.3645009994506836, 0.810886025428772], [0.2296220064163208, 0.7004590034484863], [0.17328700423240662, 0.7212520241737366], [0.47287899255752563, 0.3338020145893097], [0.4468280076980591, 0.3314729928970337], [0.422762006521225, 0.32611000537872314], [0.44530799984931946, 0.4199340045452118], [0.38810300827026367, 0.3060390055179596], [0.40303900837898254, 0.29346001148223877], [0.40362900495529175, 0.3060469925403595], [0.46004199981689453, 0.44286099076271057], [0.43115800619125366, 0.30763399600982666], [0.45218199491500854, 0.30763399600982666], [0.47538700699806213, 0.30763399600982666], [0.465828001499176, 0.22080999612808228], [0.4723289906978607, 0.26377400755882263], [0.47308701276779175, 0.2821429967880249], [0.4731220006942749, 0.2953740060329437], [0.47303301095962524, 0.30472201108932495], [0.4279420077800751, 0.30472201108932495], [0.4264790117740631, 0.29646000266075134], [0.4231620132923126, 0.2881540060043335], [0.4183090031147003, 0.2799369990825653], [0.3900949954986572, 0.36042699217796326], [0.013953999616205692, 0.43996599316596985], [0.4999139904975891, 0.41985300183296204], [0.4131999909877777, 0.3046000003814697], [0.4096260070800781, 0.29817700386047363], [0.4680800139904022, 0.39846500754356384], [0.4227289855480194, 0.414014995098114], [0.4630799889564514, 0.40621599555015564], [0.3721199929714203, 0.5265859961509705], [0.3345620036125183, 0.5039269924163818], [0.4116710126399994, 0.45303499698638916], [0.24217599630355835, 0.8523240089416504], [0.2907769978046417, 0.798554003238678], [0.32733801007270813, 0.7434729933738708], [0.399509996175766, 0.2510789930820465], [0.44172799587249756, 0.738323986530304], [0.429764986038208, 0.8121659755706787], [0.412198007106781, 0.8910989761352539], [0.2889550030231476, 0.6010479927062988], [0.2189369946718216, 0.5645890235900879], [0.4127820134162903, 0.6010299921035767], [0.2571350038051605, 0.6445599794387817], [0.4276849925518036, 0.5620390176773071], [0.4483399987220764, 0.4630639851093292], [0.17856000363826752, 0.5424460172653198], [0.24730800092220306, 0.5428060293197632], [0.2862670123577118, 0.532325029373169], [0.33282798528671265, 0.5392879843711853], [0.3687559962272644, 0.552793025970459], [0.398963987827301, 0.5673450231552124], [0.47641000151634216, 0.5941939949989319], [0.18924100697040558, 0.47607600688934326], [0.2289620041847229, 0.651049017906189], [0.4907259941101074, 0.4375990033149719], [0.40467000007629395, 0.5148670077323914], [0.0194690003991127, 0.5984359979629517], [0.42624300718307495, 0.5795689821243286], [0.3969930112361908, 0.45120298862457275], [0.2664699852466583, 0.6230229735374451], [0.4391210079193115, 0.4810419976711273], [0.0323139987885952, 0.35564300417900085], [0.4190540015697479, 0.6128450036048889], [0.46278300881385803, 0.494253009557724], [0.23897899687290192, 0.22025500237941742], [0.19822099804878235, 0.1680620014667511], [0.1075500026345253, 0.4592449963092804], [0.1836100071668625, 0.25974300503730774], [0.13440999388694763, 0.6663169860839844], [0.3857640027999878, 0.11684600263834], [0.4909670054912567, 0.42062199115753174], [0.3823849856853485, 0.4914270043373108], [0.1743990033864975, 0.6023290157318115], [0.31878501176834106, 0.6037650108337402], [0.34336400032043457, 0.5994030237197876], [0.3961000144481659, 0.2897830009460449], [0.18788500130176544, 0.4114620089530945], [0.43098700046539307, 0.05593499913811684], [0.3189930021762848, 0.10171499848365784], [0.2662479877471924, 0.13029900193214417], [0.5000230073928833, 0.8094239830970764], [0.4999769926071167, 0.0455470010638237], [0.3661699891090393, 0.601177990436554], [0.39320701360702515, 0.6044629812240601], [0.4103730022907257, 0.6089199781417847], [0.1949930042028427, 0.6578980088233948], [0.38866499066352844, 0.6377159953117371], [0.3659619987010956, 0.6440290212631226], [0.34336400032043457, 0.6446430087089539], [0.31878501176834106, 0.6416599750518799], [0.30141499638557434, 0.6368439793586731], [0.058132998645305634, 0.6809239983558655], [0.30141499638557434, 0.6125509738922119], [0.49998798966407776, 0.38156598806381226], [0.41583800315856934, 0.37580400705337524], [0.44568198919296265, 0.43392300605773926], [0.4658440053462982, 0.37935900688171387], [0.4999229907989502, 0.6484760046005249], [0.2887189984321594, 0.18005399405956268], [0.3352789878845215, 0.1471800059080124], [0.4405120015144348, 0.09758099913597107], [0.12829400599002838, 0.20805899798870087], [0.40877199172973633, 0.6261060237884521], [0.45560699701309204, 0.5481989979743958], [0.499877005815506, 0.09100999683141708], [0.3754369914531708, 0.07580800354480743], [0.11421000212430954, 0.3849779963493347], [0.44866201281547546, 0.30472201108932495], [0.44802001118659973, 0.2953679859638214], [0.44711199402809143, 0.2841919958591461], [0.4448319971561432, 0.2692059874534607], [0.4300119876861572, 0.23319099843502045], [0.4067870080471039, 0.3143270015716553], [0.400738000869751, 0.3189310133457184], [0.39239999651908875, 0.32229700684547424], [0.3678559958934784, 0.33608099818229675], [0.24792300164699554, 0.39866700768470764], [0.4527699947357178, 0.5791500210762024], [0.43639200925827026, 0.6401129961013794], [0.41616401076316833, 0.6312860250473022], [0.4133859872817993, 0.30763399600982666], [0.22801800072193146, 0.316428005695343], [0.4682680070400238, 0.6473289728164673], [0.4113619923591614, 0.19567300379276276], [0.49998900294303894, 0.530174970626831], [0.47915399074554443, 0.557345986366272], [0.49997401237487793, 0.5603629946708679], [0.4321120083332062, 0.5064110159873962], [0.49988600611686707, 0.13308300077915192], [0.4999130070209503, 0.17827099561691284], [0.4565489888191223, 0.18079900741577148], [0.3445490002632141, 0.25456100702285767], [0.37890899181365967, 0.4259899854660034], [0.3742929995059967, 0.21981500089168549], [0.31968799233436584, 0.4292620122432709], [0.3571549952030182, 0.39572998881340027], [0.2952840030193329, 0.37841901183128357], [0.4477500021457672, 0.13752299547195435], [0.4109860062599182, 0.4912770092487335], [0.3139509856700897, 0.22469200193881989], [0.35412800312042236, 0.18744699656963348], [0.32454800605773926, 0.2960070073604584], [0.18909600377082825, 0.35370001196861267], [0.27977699041366577, 0.2853420078754425], [0.13382300734519958, 0.3172990083694458], [0.3367680013179779, 0.3552669882774353], [0.4298839867115021, 0.5334780216217041], [0.45552799105644226, 0.4513770043849945], [0.43711400032043457, 0.441103994846344], [0.46728798747062683, 0.47007501125335693], [0.41471201181411743, 0.6647800207138062], [0.37704598903656006, 0.6772220134735107], [0.344107985496521, 0.6798490285873413], [0.31287598609924316, 0.6776679754257202], [0.2835260033607483, 0.6668099761009216], [0.24124599993228912, 0.617214024066925], [0.10298600047826767, 0.531237006187439], [0.2676120102405548, 0.575439989566803], [0.29787901043891907, 0.5668240189552307], [0.33343398571014404, 0.5661219954490662], [0.3664270043373108, 0.5738840103149414], [0.39601200819015503, 0.5833039879798889], [0.4201210141181946, 0.5897719860076904], [0.0075610000640153885, 0.5192229747772217], [0.4329490065574646, 0.43048200011253357], [0.458638995885849, 0.5209109783172607], [0.47346600890159607, 0.45425599813461304], [0.4760879874229431, 0.4361700117588043], [0.4684720039367676, 0.44494301080703735], [0.4339909851551056, 0.41763800382614136], [0.48351800441741943, 0.43701601028442383], [0.48248299956321716, 0.42215099930763245], [0.4264500141143799, 0.6102010011672974], [0.4389989972114563, 0.60350501537323], [0.45006701350212097, 0.5995659828186035], [0.28971201181411743, 0.6317470073699951], [0.27667000889778137, 0.6366270184516907], [0.5178620219230652, 0.5280519723892212], [0.7102879881858826, 0.6192359924316406], [0.5262269973754883, 0.4260900020599365], [0.8950930237770081, 0.7458590269088745], [0.6340699791908264, 0.5904240012168884], [0.6612420082092285, 0.5869749784469604], [0.6888800263404846, 0.5905399918556213], [0.7253419756889343, 0.6108689904212952], [0.6066300272941589, 0.5962949991226196], [0.6547660231590271, 0.6559889912605286], [0.6299059987068176, 0.6539239883422852], [0.6806780099868774, 0.6527349948883057], [0.7020969986915588, 0.6464089751243591], [0.7522119879722595, 0.5891950130462646], [0.6029180288314819, 0.15713700652122498], [0.719901978969574, 0.6244000196456909], [0.8936929702758789, 0.6000400185585022], [0.7900819778442383, 0.6086459755897522], [0.6439980268478394, 0.4655120074748993], [0.5282490253448486, 0.3495959937572479], [0.5258499979972839, 0.3198089897632599], [0.5602149963378906, 0.3427709937095642], [0.5853840112686157, 0.3334589898586273], [0.5496259927749634, 0.3191390037536621], [0.57122802734375, 0.3173080086708069], [0.6248520016670227, 0.27190101146698], [0.5130500197410583, 0.45271798968315125], [0.5150970220565796, 0.4727480113506317], [0.7422469854354858, 0.685492992401123], [0.5986310243606567, 0.5450209975242615], [0.5703380107879639, 0.4514249861240387], [0.5786319971084595, 0.46637699007987976], [0.7230870127677917, 0.46794599294662476], [0.5164459943771362, 0.5003610253334045], [0.6628010272979736, 0.7170820236206055], [0.7036240100860596, 0.706728994846344], [0.8307049870491028, 0.8061860203742981], [0.5523859858512878, 0.6974319815635681], [0.6076099872589111, 0.6461120247840881], [0.6454290151596069, 0.30329298973083496], [0.9326949715614319, 0.2698949873447418], [0.5572609901428223, 0.42717400193214417], [0.5429019927978516, 0.41520801186561584], [0.6180260181427002, 0.30528900027275085], [0.6075909733772278, 0.3057970106601715], [0.7229430079460144, 0.7280369997024536], [0.5774139761924744, 0.436832994222641], [0.6140829920768738, 0.7186130285263062], [0.616907000541687, 0.7441139817237854], [0.6685090065002441, 0.8800860047340393], [0.7700920104980469, 0.7679790258407593], [0.6355360150337219, 0.8107510209083557], [0.7703909873962402, 0.7004439830780029], [0.8267220258712769, 0.7212449908256531], [0.5271210074424744, 0.3338020145893097], [0.5531719923019409, 0.3314729928970337], [0.5772380232810974, 0.32611000537872314], [0.5546919703483582, 0.4199340045452118], [0.6118969917297363, 0.3060390055179596], [0.5969610214233398, 0.29346001148223877], [0.5963709950447083, 0.3060469925403595], [0.5399580001831055, 0.44286099076271057], [0.5688419938087463, 0.30763399600982666], [0.5478180050849915, 0.30763399600982666], [0.5246130228042603, 0.30763399600982666], [0.534089982509613, 0.22085900604724884], [0.5276709794998169, 0.26377400755882263], [0.5269129872322083, 0.2821429967880249], [0.5268779993057251, 0.2953740060329437], [0.5269669890403748, 0.30472201108932495], [0.5720580220222473, 0.30472201108932495], [0.5735210180282593, 0.29646000266075134], [0.5768380165100098, 0.2881540060043335], [0.5816910266876221, 0.2799369990825653], [0.6099449992179871, 0.3600899875164032], [0.9860460162162781, 0.43996599316596985], [0.5867999792098999, 0.3046000003814697], [0.5903720259666443, 0.29817700386047363], [0.531915009021759, 0.39846301078796387], [0.5772680044174194, 0.41406500339508057], [0.5369150042533875, 0.40621399879455566], [0.6275429725646973, 0.5266479849815369], [0.665585994720459, 0.5040490031242371], [0.5883539915084839, 0.45313799381256104], [0.7578240036964417, 0.8523240089416504], [0.7092499732971191, 0.7984920144081116], [0.6726840138435364, 0.7434189915657043], [0.6004089713096619, 0.250995010137558], [0.5582659840583801, 0.7383279800415039], [0.5703039765357971, 0.812129020690918], [0.5881659984588623, 0.8909559845924377], [0.7110450267791748, 0.6010479927062988], [0.7810699939727783, 0.5645949840545654], [0.5872470140457153, 0.6010680198669434], [0.7428699731826782, 0.6445540189743042], [0.5721560120582581, 0.5623480081558228], [0.5518680214881897, 0.4634299874305725], [0.8214420080184937, 0.5424439907073975], [0.752701997756958, 0.542818009853363], [0.7137569785118103, 0.5323730111122131], [0.6671130061149597, 0.5393270254135132], [0.6311010122299194, 0.5528460144996643], [0.6008620262145996, 0.5675269961357117], [0.523481011390686, 0.5943729877471924], [0.8107479810714722, 0.4760740101337433], [0.771045982837677, 0.6510409712791443], [0.5091270208358765, 0.437281996011734], [0.5952929854393005, 0.5149760246276855], [0.9805309772491455, 0.5984359979629517], [0.5734999775886536, 0.5799999833106995], [0.602994978427887, 0.45131200551986694], [0.7335299849510193, 0.6230229735374451], [0.5606110095977783, 0.4809829890727997], [0.9676859974861145, 0.35564300417900085], [0.5809850096702576, 0.6128399968147278], [0.5377280116081238, 0.49461498856544495], [0.7609660029411316, 0.22024700045585632], [0.8017789721488953, 0.1680620014667511], [0.8924409747123718, 0.45923900604248047], [0.8163509964942932, 0.2597399950027466], [0.8655949831008911, 0.6663129925727844], [0.6140739917755127, 0.11675400286912918], [0.5089529752731323, 0.4205619990825653], [0.6179419755935669, 0.4916839897632599], [0.8256080150604248, 0.6023250222206116], [0.6812149882316589, 0.6037650108337402], [0.6566359996795654, 0.5994030237197876], [0.6039000153541565, 0.2897830009460449], [0.8120859861373901, 0.4114609956741333], [0.5680130124092102, 0.055435001850128174], [0.681007981300354, 0.10171499848365784], [0.7337520122528076, 0.13029900193214417], [0.6338300108909607, 0.601177990436554], [0.6067929863929749, 0.6044629812240601], [0.5896599888801575, 0.6089379787445068], [0.8050159811973572, 0.6578919887542725], [0.6113349795341492, 0.6377159953117371], [0.634037971496582, 0.6440290212631226], [0.6566359996795654, 0.6446430087089539], [0.6812149882316589, 0.6416599750518799], [0.6985849738121033, 0.6368439793586731], [0.9418669939041138, 0.6809239983558655], [0.6985849738121033, 0.6125509738922119], [0.5841770172119141, 0.3758929967880249], [0.5543180108070374, 0.43392300605773926], [0.5341539978981018, 0.37935999035835266], [0.711217999458313, 0.18002499639987946], [0.6646299958229065, 0.14712899923324585], [0.5590999722480774, 0.09736800193786621], [0.8717060089111328, 0.20805899798870087], [0.591234028339386, 0.6261060237884521], [0.5443410277366638, 0.548416018486023], [0.6245629787445068, 0.07580800354480743], [0.8857700228691101, 0.3849709928035736], [0.5513380169868469, 0.30472201108932495], [0.5519800186157227, 0.2953679859638214], [0.5528879761695862, 0.2841919958591461], [0.5551679730415344, 0.2692059874534607], [0.5699440240859985, 0.23296500742435455], [0.5932030081748962, 0.3143239915370941], [0.599261999130249, 0.3189310133457184], [0.6075999736785889, 0.32229700684547424], [0.6319379806518555, 0.33649998903274536], [0.752032995223999, 0.3986850082874298], [0.5472260117530823, 0.579604983329773], [0.563543975353241, 0.640172004699707], [0.5838410258293152, 0.6312860250473022], [0.5866140127182007, 0.30763399600982666], [0.7719150185585022, 0.3164219856262207], [0.5315970182418823, 0.6475170254707336], [0.5883709788322449, 0.19555899500846863], [0.5207970142364502, 0.5574349761009216], [0.5679849982261658, 0.5065209865570068], [0.5432829856872559, 0.18074500560760498], [0.6553170084953308, 0.25448501110076904], [0.6210089921951294, 0.4259819984436035], [0.6255599856376648, 0.21968799829483032], [0.6801980137825012, 0.42928099632263184], [0.6427639722824097, 0.39566200971603394], [0.7046629786491394, 0.3784700036048889], [0.552012026309967, 0.13740800321102142], [0.5890719890594482, 0.491362988948822], [0.6859449744224548, 0.22464300692081451], [0.6457350254058838, 0.1873600035905838], [0.6753429770469666, 0.2960219979286194], [0.8108580112457275, 0.35369500517845154], [0.7201219797134399, 0.2853330075740814], [0.8661519885063171, 0.31729501485824585], [0.6631870269775391, 0.35540300607681274], [0.5700820088386536, 0.5336740016937256], [0.5445619821548462, 0.4516240060329437], [0.5627589821815491, 0.44121500849723816], [0.5319870114326477, 0.4698599874973297], [0.5852710008621216, 0.6648229956626892], [0.6229529976844788, 0.6772210001945496], [0.655896008014679, 0.6798369884490967], [0.6871320009231567, 0.6776540279388428], [0.7164819836616516, 0.666799008846283], [0.7587569952011108, 0.6172130107879639], [0.8970130085945129, 0.5312309861183167], [0.7323920130729675, 0.575452983379364], [0.7021139860153198, 0.5668370127677917], [0.6665250062942505, 0.566133975982666], [0.6335049867630005, 0.5739120244979858], [0.603875994682312, 0.5834130048751831], [0.5796579718589783, 0.590054988861084], [0.9924399852752686, 0.5192229747772217], [0.567192018032074, 0.4305799901485443], [0.5413659811019897, 0.5211009979248047], [0.5265640020370483, 0.45388200879096985], [0.5239130258560181, 0.4361700117588043], [0.5315290093421936, 0.44494301080703735], [0.5660359859466553, 0.41767099499702454], [0.51631098985672, 0.43694600462913513], [0.5174720287322998, 0.422122985124588], [0.5735949873924255, 0.6101930141448975], [0.5606979727745056, 0.6046680212020874], [0.5497559905052185, 0.6002489924430847], [0.7102879881858826, 0.6317470073699951], [0.723330020904541, 0.6366270184516907] ]


def log(name, f):
    if DEBUG.get_debug():
        print(f"{name} logged:", f)
        print()


def cpp_compare(name, np_matrix):
    if DEBUG.get_debug():
        # reorder cpp matrix as memory alignment is not correct
        cpp_matrix = np.load(f"{name}_cpp.npy")    
        rows, cols = cpp_matrix.shape    
        cpp_matrix = np.split(np.reshape(cpp_matrix, -1), cols)
        cpp_matrix = np.stack(cpp_matrix, 1)

        print(f"{name}:", np.sum(np.abs(cpp_matrix - np_matrix[:rows, :cols])**2))
        print()


def get_metric_landmarks(screen_landmarks, pcf):
    screen_landmarks = project_xy(screen_landmarks, pcf)
    depth_offset = np.mean(screen_landmarks[2, :])

    intermediate_landmarks = screen_landmarks.copy()
    intermediate_landmarks = change_handedness(intermediate_landmarks)
    first_iteration_scale = estimate_scale(intermediate_landmarks)

    intermediate_landmarks = screen_landmarks.copy()
    intermediate_landmarks = move_and_rescale_z(pcf, depth_offset, first_iteration_scale, intermediate_landmarks)
    intermediate_landmarks = unproject_xy(pcf, intermediate_landmarks)
    intermediate_landmarks = change_handedness(intermediate_landmarks)
    second_iteration_scale = estimate_scale(intermediate_landmarks)

    metric_landmarks = screen_landmarks.copy()
    total_scale = first_iteration_scale * second_iteration_scale
    metric_landmarks = move_and_rescale_z(pcf, depth_offset, total_scale, metric_landmarks)
    metric_landmarks = unproject_xy(pcf, metric_landmarks)
    metric_landmarks = change_handedness(metric_landmarks)

    pose_transform_mat = solve_weighted_orthogonal_problem(canonical_metric_landmarks, metric_landmarks, landmark_weights)
    cpp_compare("pose_transform_mat", pose_transform_mat)

    inv_pose_transform_mat = np.linalg.inv(pose_transform_mat)
    inv_pose_rotation = inv_pose_transform_mat[:3, :3]
    inv_pose_translation = inv_pose_transform_mat[:3, 3]

    metric_landmarks = inv_pose_rotation @ metric_landmarks + inv_pose_translation[:, None]

    return metric_landmarks, pose_transform_mat


def project_xy(landmarks, pcf):
    x_scale = pcf.right - pcf.left
    y_scale = pcf.top - pcf.bottom
    x_translation = pcf.left
    y_translation = pcf.bottom
    
    landmarks[1,:] = 1.0 - landmarks[1,:]
    
    landmarks = landmarks * np.array([[x_scale,y_scale,x_scale]]).T
    landmarks = landmarks + np.array([[x_translation,y_translation,0]]).T
    
    return landmarks


def change_handedness(landmarks):
    landmarks[2,:] *= -1.0
    
    return landmarks


def move_and_rescale_z(pcf, depth_offset, scale, landmarks):
    landmarks[2,:] = (landmarks[2,:] - depth_offset + pcf.near) / scale
    
    return landmarks


def unproject_xy(pcf, landmarks):
    landmarks[0,:] = landmarks[0,:] * landmarks[2,:] / pcf.near
    landmarks[1,:] = landmarks[1,:] * landmarks[2,:] / pcf.near
    
    return landmarks


def estimate_scale(landmarks):
    transform_mat = solve_weighted_orthogonal_problem(canonical_metric_landmarks, landmarks, landmark_weights)
    
    return np.linalg.norm(transform_mat[:,0])


def extract_square_root(point_weights):
    return np.sqrt(point_weights)


def solve_weighted_orthogonal_problem(source_points, target_points, point_weights):    
    sqrt_weights = extract_square_root(point_weights)
    transform_mat = internal_solve_weighted_orthogonal_problem(source_points, target_points, sqrt_weights)
    return transform_mat


def internal_solve_weighted_orthogonal_problem(sources, targets, sqrt_weights):
    cpp_compare("sources", sources)
    cpp_compare("targets", targets)
    
    # tranposed(A_w).
    weighted_sources = sources * sqrt_weights[None,:]
    # tranposed(B_w).
    weighted_targets = targets * sqrt_weights[None,:]
    
    cpp_compare("weighted_sources", weighted_sources)
    cpp_compare("weighted_targets", weighted_targets)
    
    # w = tranposed(j_w) j_w.
    total_weight = np.sum(sqrt_weights * sqrt_weights)
    log("total_weight", total_weight)

    # Let C = (j_w tranposed(j_w)) / (tranposed(j_w) j_w).
    # Note that C = tranposed(C), hence (I - C) = tranposed(I - C).
    #
    # tranposed(A_w) C = tranposed(A_w) j_w tranposed(j_w) / w =
    # (tranposed(A_w) j_w) tranposed(j_w) / w = c_w tranposed(j_w),
    #
    # where c_w = tranposed(A_w) j_w / w is a k x 1 vector calculated here:
    twice_weighted_sources = weighted_sources * sqrt_weights[None,:]
    source_center_of_mass = np.sum(twice_weighted_sources, axis=1) / total_weight;
    log("source_center_of_mass", source_center_of_mass)
    
    # tranposed((I - C) A_w) = tranposed(A_w) (I - C) =
    # tranposed(A_w) - tranposed(A_w) C = tranposed(A_w) - c_w tranposed(j_w).
    centered_weighted_sources = weighted_sources - np.matmul(source_center_of_mass[:,None], sqrt_weights[None,:])
    cpp_compare("centered_weighted_sources", centered_weighted_sources)
    
    design_matrix = np.matmul(weighted_targets, centered_weighted_sources.T)
    cpp_compare("design_matrix", design_matrix)
    log("design_matrix_norm", np.linalg.norm(design_matrix))
    
    rotation = compute_optimal_rotation(design_matrix)
    
    scale = compute_optimal_scale(centered_weighted_sources, weighted_sources, weighted_targets, rotation)
    log("scale", scale)
    
    rotation_and_scale = scale * rotation;
    
    pointwise_diffs = weighted_targets - np.matmul(rotation_and_scale, weighted_sources)
    cpp_compare("pointwise_diffs", pointwise_diffs)
        
    weighted_pointwise_diffs = pointwise_diffs * sqrt_weights[None,:]
    cpp_compare("weighted_pointwise_diffs", weighted_pointwise_diffs)
    
    translation = np.sum(weighted_pointwise_diffs, axis=1) / total_weight
    log("translation", translation)
    
    transform_mat = combine_transform_matrix(rotation_and_scale, translation)    
    cpp_compare("transform_mat", transform_mat)
    
    return transform_mat


def compute_optimal_rotation(design_matrix):
    if np.linalg.norm(design_matrix) < 1e-9:
        print("Design matrix norm is too small!")
        
    u, _, vh = np.linalg.svd(design_matrix, full_matrices=True)
    
    postrotation = u
    prerotation = vh
    
    if np.linalg.det(postrotation) * np.linalg.det(prerotation) < 0:
        postrotation[:,2] = -1 * postrotation[:,2]
    
    cpp_compare("postrotation", postrotation)
    cpp_compare("prerotation", prerotation)
    
    rotation = np.matmul(postrotation, prerotation)
    
    cpp_compare("rotation", rotation)
    
    return rotation


def compute_optimal_scale(centered_weighted_sources, weighted_sources, weighted_targets, rotation):
    rotated_centered_weighted_sources = np.matmul(rotation, centered_weighted_sources)
    
    numerator = np.sum(rotated_centered_weighted_sources * weighted_targets)
    denominator = np.sum(centered_weighted_sources * weighted_sources)
    
    if denominator < 1e-9:
        print("Scale expression denominator is too small!")
    if numerator / denominator < 1e-9:
        print("Scale is too small!")
        
    return numerator / denominator


def combine_transform_matrix(r_and_s, t):
    result = np.eye(4)
    result[:3, :3] = r_and_s
    result[:3, 3] = t    
    return result